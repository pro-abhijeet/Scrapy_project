import scraper_helper
import scrapy
from ..items import TutorialItem
from bs4 import BeautifulSoup
import scraper_helper as sh
from requests import request
from lxml import html


class qspider(scrapy.Spider):
    name = "quotes"
    urls = ["https://www.goskills.com/Course/Excel-Power-Pivot"]
    sub_price = request(method="GET", url=urls[0] + "/Pricing?source=course-about")
    request_response = html.fromstring(sub_price.content)
    pricing = request_response.xpath("//*[@id='course-pricing']//*[@class='panel-body']/h4[contains(text(),'Year')]/..//*[@class='before-decimal-point']//text()")[0]

    def start_requests(self):
        urls = ["https://www.goskills.com/Course/Excel-Advanced"]
        # sub_price = request(method="GET",url=urls[0]+"/Pricing?source=course-about")
        # request_response = html.fromstring(sub_price.content)
        # pricing = request_response.xpath("//*[@id='course-pricing']//*[@class='panel-body']/h4[contains(text(),'Year')]/..//*[@class='before-decimal-point']//text()")[0]
        for url in urls:
            yield scrapy.Request(url=url, callback=self.parse, cb_kwargs={'price':self.pricing})

    def parse(self, response, price):
        items = TutorialItem()
        title = response.css('.h2-sm::text').extract()
        title = [titl.strip() for titl in title]
        title = "".join(title)


        try:
            description = response.css('#course-about-outline p::text').getall()
            description = [desc.strip() for desc in description]
            description = "".join(description)
            description = "<p>"+description+"</p>"
        except:
            pass
        # try:
        #     description = response.css('#course-about-outline h3+ p::text').getall()
        #     description = [desc.strip() for desc in description]
        #     description = "".join(description)
        #     description = "<p>"+description+"</p>"
        # except:
        #     pass

        faq_question = response.xpath("//*[@id='faq-list']//*[@class='panel-title collapsed']//following-sibling::text()[2]").getall()
        faq_question = [ques.strip() for ques in faq_question]
        faq_question = "|".join(faq_question)


        try:
            duration = response.css('.summary:nth-child(8) .summary-text::text').getall()
            duration = [dur.strip() for dur in duration]
            duration = "".join(duration)
            duration  = duration.replace(' for all materials','')
        except:
            duration = response.css('.summary:nth-child(7) .summary-text::text').getall()
            duration = [dur.strip() for dur in duration]
            duration = "".join(duration)
            duration = duration.replace(' for all materials', '')


        instructor_name = response.css('#course-about-tutors h3::text').getall()
        instructor_name = [ins.strip() for ins in instructor_name]
        instructor_name = "|".join(instructor_name)
        instructor_image = response.css('#course-about-tutors .m-right-md::attr(src)').extract()
        instructor_image = ["https://www.goskills.com"+inss.strip() for inss in instructor_image]
        instructor_image = "|".join(instructor_image)
        instructor_designation = response.css('#course-about-tutors .small::text').extract()
        instructor_designation = [insss.strip() for insss in instructor_designation]
        instructor_designation = "|".join(instructor_designation)
        reviewer_name = response.css('#testimonials-carousel .small::text').extract()
        reviewer_name = [rev.strip() for rev in reviewer_name]
        reviewer_name = "|".join(reviewer_name)
        reviewer_review = response.css('#testimonials-carousel p:nth-child(1)::text').extract()
        reviewer_review = [revv.strip() for revv in reviewer_review]
        reviewer_review = "|".join(reviewer_review)
        level = response.css('.summary:nth-child(1) .summary-text::text').extract()
        level = [lev.strip() for lev in level]
        level = "".join(level)
        faq_answers = response.css('#faq-9-answer .panel-body , #faq-8-answer p , #faq-7-answer .panel-body , #faq-6-answer .panel-body , #faq-5-answer .panel-body , #faq-4-answer p , #faq-3-answer .panel-body , #faq-2-answer .panel-body , #faq-1-answer p , #faq-0-answer .panel-body').css('::text').extract()
        faq_answers = [ans.strip() for ans in faq_answers]
        faq_answers = "|".join(faq_answers)
        syllabus = response.css('#course-about-syllabus .btn-outline::attr(href)').extract()
        syllabus = ["https://www.goskills.com"+syl.strip() for syl in syllabus]
        syllabus = "".join(syllabus)
        try:
            prerequisites = response.css('.summary~ .summary+ .summary a::text').extract()
            prerequisites = [pre.strip() for pre in prerequisites]
            prerequisites = "".join(prerequisites)
        except:
            prerequisites = response.css('.summary:nth-child(5) .summary-text::text').extract()
            prerequisites = [pre.strip() for pre in prerequisites]
            prerequisites = "".join(prerequisites)

        try:
            what_will_learn = response.css('#course-about-outline li::text').getall()
            what_will_learn = [what.strip() for what in what_will_learn]
            what_will_learn = "|".join(what_will_learn)
        except:
            what_will_learn = response.css('#course-about-outline ul li::text').getall()
            what_will_learn = [what.strip() for what in what_will_learn]
            what_will_learn = "|".join(what_will_learn)

        # try:
        #     what_will_learn = response.css('#course-about-outline p:nth-child(2)::text').getall()
        #     what_will_learn = [what.strip() for what in what_will_learn]
        #     what_will_learn = "|".join(what_will_learn)
        # except:
        #     pass

        accreditation_name = response.css('.summary:nth-child(4) .summary-text::text').getall()
        accreditation_name = [acc.strip() for acc in accreditation_name]
        accreditation_name = "|".join(accreditation_name)
        accreditation_image = response.css('#course-about-accreditations img::attr(src)').getall()
        accreditation_image = ["https://www.goskills.com"+accc.strip() for accc in accreditation_image]
        accreditation_image = " | ".join(accreditation_image)
        short_description = response.css('#course-about-outline p:nth-child(1)::text').getall()
        short_description = [sho.strip() for sho in short_description]
        short_description = "".join(short_description)

        content_heading = response.css('#course-about-syllabus-accordion .collapsed::text').extract()
        content_heading = [head.strip() for head in content_heading]
        content_heading = "|".join(content_heading)
        content_description = response.css('#course-about-syllabus-accordion p::text').extract()
        content_description = [descc.strip() for descc in content_description]
        content_description = "|".join(content_description)
        content_heading = scraper_helper.cleanup(content_heading)






        items['title'] = title
        items['what_will_learn'] = what_will_learn
        items['description'] = description
        items['faq_question'] = faq_question
        items['duration'] = duration
        items['price'] = price
        items['instructor_name'] = instructor_name
        items['instructor_image'] = instructor_image
        items['instructor_designation'] = instructor_designation
        items['reviewer_name'] = reviewer_name
        items['reviewer_review'] = reviewer_review
        items['level'] = level
        items['faq_answers'] = faq_answers
        items['syllabus'] = syllabus
        items['prerequisites'] = prerequisites
        items['accreditation_name'] = accreditation_name
        items['accreditation_image'] = accreditation_image
        items['short_description'] = short_description
        items['content_heading'] = content_heading
        items['content_description'] = content_description
        yield items


